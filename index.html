<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Demystifying AJAX Callback Commands in Drupal 8</title>

		<meta name="description" content="Demystifying AJAX Callback Commands in Drupal 8">
		<meta name="author" content="Mike Miles">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/miles.css" id="theme">
    <link rel="stylesheet" href="css/miles-color.css">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">
		<link rel="stylesheet" href="css/code.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">
      <div class="footer">
        <div class="branding--logo">
            <span class="logo__image"><img src="lib/image/content/logo.png" alt="Conference logo" height="55px" /></span>
            <p class="logo__site-name">#midcamp</p>
        </div>
        <div class="company--logo">
            <span class="logo__image"><img src="/images/genuine_logo_white.png" alt="Genuine" height="40px" width="40px" /></span>
            <p class="logo__site-name">@WeAreGenuine</p>
        </div>
        <div class="session--info">
            <p class="session__title">
              D8 AJAX <span class="seperator">&nbsp;/&nbsp;</span>
            </p>
            <p class="session__presenter">Michael Miles</p>
        </div>
    </div>

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <section data-transition="convex">
            <h1>Demystifying AJAX Callback Commands</h1>
            <h2>(in Drupal 8)</h2>
            <p><a href="//2016.midcamp.org/session/demystifying-ajax-callback-commands-drupal-8" target="_blank">2016.midcamp.org/node/48</a></p>
            <p>MidCamp 2016 - #midcamp</p>
          </section>
            <section data-transition="convex">
              <h2>Goals of this Session</h2>
              <p>
                  <ul>
                    <li class="fragment">Explain what are AJAX callback commands</li>
                    <li class="fragment">Demonstrate how to use AJAX callback commands</li>
                    <li class="fragment">Outline how to create AJAX callback commands</li>
                  </ul>
              </p>
            </section>
              <section data-transition="convex">
                <h2>Michael Miles</h2>
                <p class="fragment">
                  <strong>From: </strong>Boston, MA USA
                </p>
                <p class="fragment">
                  <strong>Work: </strong>
                  <a href="http://wearegenuine.com" target="_blank">Genuine</a>
                    <span style="font-size:70%"> @WeAreGenuine(.com)</span><br />
                    <span class="filename">(I have stickers!)</span>
                </p>
                <p class="fragment">
                  <strong>Exp:</strong> Working with Drupal since 2008.<br />
                </p>
                <p>
                  <span class="fragment">Acquia Grand Master.</span>
                  <span class="fragment">2014 Acquia MVP.</span>
                </p>
                <br />
                <p>
                  <span class="fragment"><strong>Twitter:</strong> @mikemiles86</span>
                  <span class="fragment"><strong>Drupal.org:</strong> mikemiles86</span>
                  <br />
                  <span class="fragment"><strong>All the Places:</strong> mikemiles86</span>
                </p>
                <aside class="notes">
                  <ul>
                    <li>Genuine - full service digital agency</li>
                    <li>Specialize in Brand engagments, SEO, UX, Design, Video, Development</li>
                    <li>Home Office in Boston. Offices in NYC, SF, Chicago</li>
                  </ul>
                </aside>
            </section>
          <section data-transition="convex">
            <h2>Warning About Example Code</h2>
            <ul>
              <li class="fragment">There is example code</li>
              <li class="fragment">Some coding standards ignored</li>
            </ul>
          </section>
        </section>
        <section>
          <section data-transition="convex">
            <h2>What are Callback Commands</h2>
            <aside class="notes">
              Explain what AJAX Callback commands are from a high level and how Drupal uses them.
              Explain what an AJAX Callback command is on the Client Side and on the Server Side.
            </aside>
          </section>
          <section data-transition="convex">
            <h3>From a High Level</h3>
            <ul>
              <li class="fragment step-note">The response of all AJAX requests</li>
              <li class="fragment step-note">A JavaScript method attached to an object</li>
              <li class="fragment step-note">PHP code to invoke a JavaScript method</li>
            </ul>
            <aside class="notes">
              What are returned by an AJAX request from AJAX Framework.
              Framework replaced AHAH.
              A Global JS object provided by Drupal.
              An extendable system, like most of Drupal.
            </aside>
          </section>
          <section data-transition="convex">
            <h4>Example: The "Remove" Command</h4>
            <img class="section-gif" data-src="images/ajax-commands-remove-example.gif" alt="Showing use of the 'remove' AJAX Callback command. A link is clicked, which makes an AJAX request, which returns the command to remove the image on the page." />
            <p class="caption">
              Showing use of the 'remove' AJAX Callback command. A link is clicked, which makes an AJAX request, which returns the command to remove the image on the page.
            </p>
          </section>
          <section data-transition="convex">
            <h3>On the Client Side</h3>
            <ul>
              <li class="fragment step-note">A wrapper for additional javascript</li>
              <li class="fragment step-note">A method on the 'Drupal.AjaxCommands.prototype' object</li>
              <li class="fragment step-note">Accepts three arguments:
                <ul>
                  <li class="fragment">ajax</li>
                  <li class="fragment">response</li>
                  <li class="fragment">status</li>
                </ul>
              </li>
            </ul>
            <aside class="notes">
              ajax : triggering element, callback made, DOM element attached to.
              response: Data returned from the request
              status: the status code of the response.
            </aside>
          </section>
          <section data-transition="convex">
            <h4 class="step-note">Core Example: Remove Command (JavaScript)</h4>
            <pre><code class="js line-numbers" data-trim>
              Drupal.AjaxCommands.prototype = {
  // ...
  /**
   * Command to remove a chunk from the page.
   *
   * @param {Drupal.Ajax} [ajax]
   * @param {object} response
   * @param {string} response.selector
   * @param {object} [response.settings]
   * @param {number} [status]
   */
  remove: function (ajax, response, status) {
    var settings = response.settings || ajax.settings || drupalSettings;
    $(response.selector).each(function () {
      Drupal.detachBehaviors(this, settings);
    })
      .remove();
  },
  //...
            </code><span class="codename">misc/ajax.js </span></pre>
          </section>
          <section data-transition="convex">
            <h3>On the Server Side</h3>
            <ul>
              <li class="fragment step-note">A PHP class which implements ControllerBase</li>
              <li class="fragment step-note">Class must have a 'render' method</li>
              <li class="fragment step-note">'render' must return an associative array
                <ul>
                  <li class="fragment">Must have a 'command' element</li>
                  <li class="fragment">Value is name of Javascript command</li>
                  <li class="fragment">Additional elements sent as response data</li>
                </ul>
              </li>
            </ul>
          </section>
          <section data-transition="convex">
            <h4 class="step-note">Core Example: Remove Command (PHP)</h4>
            <pre><code class="php line-numbers" data-trim>
namespace Drupal\Core\Ajax;
/**
 * AJAX command for calling the jQuery remove() method.
 * ...
 */
class RemoveCommand Implements CommandInterface {
  // ...
  /**
   * Implements Drupal\Core\Ajax\CommandInterface:render().
   */
  public function render() {
    return array(
      'command' => 'remove',
      'selector' => $this->selector,
    );
  }
}
            </code><span class="codename">core/lib/Drupal/Core/Ajax/RemoveCommand.php </span></pre>
          </section>
        </section>
         <section>
          <section data-transition="convex">
            <h2>Using Callback Commands</h2>
            <aside class="notes">
              Exmaple scenario for using AJAX Callback Commands.
              Go through the proccess of implmeneting the use of AJAX Callback Commands.
            </aside>
          </section>
          <section data-transition="convex">
            <h3>Example Scenario</h3>
            <img data-src="images/ajax-dblog-example.gif" class="screenshot" alt="Example Scenario. Want to use Ajax commands to improve the dblog page." />
          <p class="caption">
            Example Scenario. Want to use Ajax commands to improve the dblog page.
          </p>
          </section>
          <section data-transition="convex">
              <h3>To Use Commands...</h3>
              <ol>
                <li class="fragment step-note">Include Drupal AJAX JavaScript library</li>
                <li class="fragment step-note">Attach AJAX to page elements</li>
                <li class="fragment step-note">
                  Define a callback path and method
                  <ul>
                    <li class="fragment">Returns an AjaxResponse object</li>
                  </ul>
                </li>
              </ol>
              <aside class="notes">
                3 steps<br />
                <ol>
                  <li>Include AJAX library</li>
                  <li>Add AJAX to an element</li>
                  <li>Define callback, which returns render response</li>
                </ol>
              </aside>
          </section>
          <section data-transition="convex">
            <h4 class="step-note">1. Include Drupal AJAX library</h4>
            <pre><code data-trim class="php line-numbers">
// Returns responses for ajax_dblog routes.
class DbLogController extends ControllerBase {
  // Override parent overview() method.
  public function overview() {
    // Call the parent overview method.
    $build = parent::overview();
    // Alter the links for each log message.
    foreach ($build['dblog_table']['#rows'] as &$row) {
      // ...
    }
    // Add Ajax library.
    $build['#attached']['library'][] = 'core/drupal.ajax';
    return $build;
  }
            </code><span class="codename">ajax_dblog/src/Controller/DbLogController.php </span></pre>
            <p class="caption">Override the method and alter the data to render the dblog page. On line #11, attach the Drupal core Ajax library to the '#attached]['library' array of the render array.</p>
          </section>
          <section data-transition="convex">
            <h4 class="step-note">2. Attach AJAX to page elements</h4>
            <pre><code data-trim class="php line-numbers">
// Returns responses for ajax_dblog routes.
class DbLogController extends ControllerBase {
  // Override parent overview() method.
  public function overview() {
    // Call the parent overview method.
    $build = parent::overview();
    // Alter the links for each log message.
    foreach ($build['dblog_table']['#rows'] as &$row) {
      //...
      // Build link options
        $options = array('attributes' => array(
            'class' => array('use-ajax', 'dblog-event-link'),
          ));
        // Replace with a new link.
        $link = Link::createFromRoute($text, 'ajax_dblog.event', $perms, $options);
        $row['data'][3] = $link;
    }
    //...
    return $build;
  }
            </code><span class="codename">ajax_dblog/src/Controller/DbLogController.php </span></pre>
            <p class="caption">Override the method and alter the data to render the dblog page. On lines #11 - 13, build array of link options. Adding the class 'use-ajax' so AJAX framework knows to serve link with an AJAX request.. On line #15 create a new link for the row item.</p>
          </section>
          <section data-transition="convex">
            <h4 class="step-note">3.a Define a callback path</h4>
            <pre><code data-trim class="yml line-numbers">
ajax_dblog.event:
  path: '/admin/reports/dblog/{method}/event/{event_id}'
  defaults:
    _controller: '\Drupal\ajax_dblog\Controller\DbLogController::ajaxEventDetails'
  requirements:
    _permission: 'access site reports'
    method: 'nojs|ajax'

            </code><span class="codename">ajax_dblog/ajax_dblog.routing.yml </span></pre>
            <p class="caption">Create a route for the Ajax callback. Use a route parameter '{method}' to handle graceful degredation if path is reached via ajax or not-ajax (nojs). On line #4 define the controller and method that will be used to return the AjaxResponse object.</p>
          </section>
          <section data-transition="convex">
            <h4 class="step-note">3.b Return an AjaxResponse object with commands.</h4>
            <pre><code data-trim class="php line-numbers">
class DbLogController extends ControllerBase {
  // ...
  // Return details about a specific database log message.
  public function ajaxEventDetails($method, $event_id) {
    // ...
    $event_url = Url::fromRoute('dblog.event', array('event_id' => $event_id));
    // Using ajax?
    if ($method == 'ajax') {
      // ...
      // Create an AjaxResponse.
      $response = new AjaxResponse();
      // Remove old row
      $response->addCommand(new RemoveCommand('#dblog-event-row-' . $event_id));
      // Insert event details after event.
      $response->addCommand(new AfterCommand('#dblog-event-' . $event_id, $event_details));
    } else {
      // Redirect to actual page.
      $response = new RedirectResponse($event_url->toString(), 302);
    }
    return $response;
  }
            </code><span class="codename">ajax_dblog/src/Controller/DbLogController.php </span></pre>
             <p class="caption"> Define a callback method in controller. Lines #12 thru #17, creating an AjaxResponse object adding multiple commands using the 'addCommand' method. Line #20 handles building a redirect response if method reached not by ajax (graceful degradation).</p>
          </section>
          <section data-transition="convex">
            <h3>Example Scenario</h3>
            <img data-src="images/ajax-commands-example.gif" class="screenshot" alt="When log event title is clicked, an ajax request is made for the details and an ajax command is returned to instert the data into the table." />
          <p class="caption">
            Example Scenario: When log event title is clicked, an ajax request is made for the details and an ajax command is returned to instert the data into the table.
          </p>
          </section>
        </section>
        <section>
          <section data-transition="convex">
            <h2>Custom Callback Commands</h2>
          </section>
          <section data-transition="convex">
            <h3>Example Scenario</h3>
            <img data-src="images/ajax-commands-example.gif" class="screenshot" alt="Example Scenario. Using ajax commands to alter the drupal dblog overview page. When log event title is clicked, an ajax request is made for the details and an ajax command is returned to instert the data into the table." />
          <p class="caption">
            Example Scenario. Would like to improve transition with a slide animation.
          </p>
          </section>
          <section data-transition="convex">
            <h3>To Create a Command...</h3>
            <ol>
              <li class="fragment step-note">Add a method to the Drupal ajax command JavaScript object</li>
              <li class="fragment step-note">Define a PHP class that implements CommandInterface</li>
              <li class="fragment step-note">Define a 'render' method
                <ul>
                  <li class="fragment">Must return associative array with a 'command' element</li>
                  <li class="fragment">Value is name of the JavaScript command</li>
                  <li class="fragment">Additional elements for response data</li>
                </ul>
              </li>
            </ol>
            <aside class="notes">
              2 steps<br />
              <ol>
                <li>Add a method to JS object.</li>
                <li>PHP code returns an associative array.</li>
              </ol>
            </aside>
          </section>
          <section data-transition="convex">
            <h4 class="step-note">1 . Add a method to 'Drupal.AjaxCommands.prototype'</h4>
            <pre><code class="js line-numbers" data-trim>
(function ($, window, Drupal, drupalSettings) {
  'use strict';
  // Command to toggle sliding of content on page.
  Drupal.AjaxCommands.prototype.slideToggle = function(ajax, response, status){
    // Get duration if sent, else use default of slow.
    var duration = response.duration ? response.duration : "slow";
    // Toggle selected element(s).
    $(response.selector).slideToggle(duration);
  }
  // ...
}
            </code><span class="codename">ajax_dblog/js/ajax.js </span></pre>
            <p class="caption">Attach a new 'slideToggle' command to the Drupal AJAX Commands JavaScript object. Function takes in the 3 arguments "ajax", "response" & "status". Wraps jQuery functions to toggle sliding (show/hide) of content based on selector.</p>
          </section>
          <section data-transition="convex">
            <h4 class="step-note">2. Define a PHP class that implements CommandInterface</h4>
            <pre><code class="php line-numbers" data-trim>
namespace Drupal\ajax_dblog\Ajax;
use Drupal\Core\Ajax\CommandInterface;
// An AJAX command for calling the jQuery slideToggle() method.
class SlideToggleCommand implements CommandInterface {
  // Constructs an SlideToggleCommand object.
  public function __construct($selector, $duration = NULL) {
    $this->selector = $selector;
    $this->duration = $duration;
  }
  // Implements Drupal\Core\Ajax\CommandInterface:render().
  public function render() {
    return array(
      'command' => 'slideToggle',
      'method' => NULL,
      'selector' => $this->selector,
      'duration' => $this->duration,
    );
  }
}
            </code><span class="codename">ajax_dblog/src/Ajax/SlideToggleCommand.php </span></pre>
             <p class="caption">A PHP class that implements 'CommandInterface' to define new SlideToggle command. Overrides the 'render' method and returns an associative array. On line #15 adds 'command' element, with value being the Javascript command name 'slideToggle'. Then additional elements to be sent as request data.</p>
          </section>
          <section data-transition="convex">
            <h3>Using a custom command...</h3>
            <ol>
              <li class="fragment step-note">Tell Drupal to include custom JavaScript</li>
              <li class="fragment step-note">Return custom command in callback function</li>
            </ol>
            <aside class="notes">
              2 steps<br />
              <ol>
                <li>Include custom JS.</li>
                <li>Return command in callback.</li>
              </ol>
            </aside>
          </section>
          <section>
            <h4 class="step-note">1.a Define a custom library in 'libraries.yml' file</h4>
            <pre><code class="yaml line-numbers" data-trim>
ajax-dblog:
  version: VERSION
  css:
    component:
      css/ajax_dblog.module.css: {}
  js:
    js/ajax.js: {}
  dependencies:
    - core/drupal.ajax
            </code><span class="codename">ajax_dblog/ajax_dblog.libraries.yml </span></pre>
            <p class="caption">Must tell Drupal about custom library with a libraries.yml file. Provide an Asset library name, lists all the files needed, and any dependencies on other libraries.</p>
          </section>
          <section data-transition="convex">
            <h4 class="step-note">1.b Include library onto page</h4>
            <pre><code class="php line-numbers" data-trim>
              // Returns responses for ajax_dblog routes.
class DbLogController extends ControllerBase {
  // Override parent overview() method.
  public function overview() {
    // Call the parent overview method.
    $build = parent::overview();
    // Alter the links for each log message.
    foreach ($build['dblog_table']['#rows'] as &$row) {
      // ...
    }
    // Add Ajax library.
    $build['#attached']['library'][] = 'ajax_dblog/ajax-dblog';
    return $build;
  }
            </code><span class="codename">ajax_dblog/src/Controller/DbLogController.php </span></pre>
            <p class="caption">On line #11, attach custom library to render array. Replaces the attachment of the core ajax library from earlier example.</p>
          </section>
          <section data-transition="convex">
            <h4 class="step-note">2. Add command to response obect returned by callback</h4>
            <pre><code data-trim class="php line-numbers">
class DbLogController extends ControllerBase {
  // ...
  // Return details about a specific database log message.
  public function ajaxEventDetails($method, $event_id) {
    // ...
    // Using ajax?
    if ($method == 'ajax') {
      // ...
      // Create an AjaxResponse.
      $response = new AjaxResponse();
      // Remove old row
      $response->addCommand(new RemoveCommand('#dblog-event-row-' . $event_id));
      // Insert event details after event.
      $response->addCommand(new AfterCommand('#dblog-event-' . $event_id, $event_details));
      // SlideToggle event details.
      $response->addCommand(new SlideToggleCommand('#dblog-event-details-' . $event_id));
    } else {
      // Redirect to actual page.
      $response = new RedirectResponse($event_url->toString(), 302);
    }
    return $response;
  }
            </code><span class="codename">ajax_dblog/src/Controller/DbLogController.php </span></pre>
             <p class="caption"> On line #19 add custom command to AjaxResponse object.</p>
          </section>
          <section data-transition="convex">
            <h3>Example Scenario</h3>
            <img data-src="images/ajax-custom-commands-example.gif" class="screenshot" alt="Example Scenario. Added a custom callback command to improve slide animation." />
            <p class="caption">
              Example Scenario. Added a custom callback command to improve slide animation.
            </p>
          </section>
        </section>
        <section>
          <section>
            <h2>Let's Review</h2>
          </section>
          <section data-transition="convex">
            <h3>AJAX Callback Commands Are...</h3>
            <ul>
              <li class="fragment step-note">Returned by all AJAX Framework requests</li>
              <li class="fragment step-note">PHP abstraction for JavaScript functions</li>
              <li class="fragment step-note">Defined by core and modules</li>
            </ul>
          </section>
          <section data-transition="convex">
            <h3>To Use AJAX Callback Commands...</h3>
            <ul>
              <li class="fragment step-note">Include Drupal AJAX JavaScript library</li>
              <li class="fragment step-note">Attach AJAX to page elements</li>
              <li class="fragment step-note">Have server side callback return array of commands</li>
            </ul>
          </section>
          <section data-transition="convex">
            <h3>To Create AJAX Callback Commands...</h3>
            <ul>
              <li class="fragment step-note">Add method to Drupal ajax command JavaScript object.</li>
              <li class="fragment step-note">Write PHP command class with a 'render' method.</li>
            </ul>
          </section>
          <section data-transition="convex">
            <h3>To Use Custom AJAX Callback Commands...</h3>
            <ul>
              <li class="fragment step-note">Include custom ibrary</li>
              <li class="fragment step-note">Include custom command in callback response</li>
            </ul>
          </section>
        </section>
        <section>
          <section>
            <h2>Resources</h2>
            <p>Drupal 8 AJAX Api: <a href="http://bit.ly/Drupal8Ajax" target="_blank">bit.ly/Drupal8Ajax</a></p>
            <p>This Presentation: <a href="http://bit.ly/Mid16Ajax" target="_blank">bit.ly/Mid16Ajax</a></p>
            <p>Presentation Slides: <a href="http://bit.ly/Mid16AjaxSlides" target="_blank">bit.ly/Mid16AjaxSlides</a></p>
            <p>Example Code: <a href="http://bit.ly/Mid16AjaxEx" target="_blank">bit.ly/Mid16AjaxEx</a></p>
            <p>Creating Commands in D8: <a href="http://bit.ly/D8AjaxCmds" target="_blank">bit.ly/D8AjaxCmds</a></p>
          </section>
          <section>
            <h2>Sprint on sunday Slide</h2>
          </section>
          <section>
            <h2>Send me feedback!</h2>
            <p><a href="//twitter/mikemiles86" target="_blank">@mikemiles86</a></p>
            <p><a href="//legacy.joind.in/17274" target="_blank">legacy.joind.in/17274</a></p>
          </section>
          <section>
           <h2>Thank You!</h2>
            <p>Questions?</p>
          </section>
        </section>
      </div>
    </div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true },
					{ src: 'lib/js/line-numbers.js', async: false },
          { src: 'lib/js/gif-loader.js', async: true},
          { src: 'lib/js/captions-aside.js', async: false},
				]
			});

		</script>

	</body>
</html>
